let initialJobsData=[{id:"coinbase-director-institutional-platform",company:"Coinbase",roleTitle:"Director Product Management - Institutional Platform",jobUrl:"https://www.coinbase.com/careers/positions/7032070",location:"Remote (SF Bay Area preferred)",status:"not-started",vibe:"üòê",fitScore:9.8,salary:"$280k - $330k + equity",tags:["Crypto","Director","Remote","Institutional","Platform"],appliedDate:null,notes:"Leading crypto exchange focused on institutional infrastructure. Strong regulatory compliance culture.",isArchived:!1,research:{companyIntel:"Global crypto exchange leader, expanding institutional offerings, strong regulatory positioning",keyPeople:["Brian Armstrong (CEO)","Alesia Haas (CFO)","Paul Grewal (Chief Legal Officer)"],recentNews:"Q3 2025 institutional trading volume up 67%, expanding European operations",competitiveAdvantage:"First-mover advantage, regulatory compliance, institutional relationships",challenges:"Regulatory uncertainty, traditional finance competition"},iceBreakers:["How is Coinbase differentiating institutional vs retail platform architecture?","What role does regulatory compliance play in product roadmap decisions?","How do you balance innovation speed with institutional-grade reliability requirements?"],objections:["May prefer deeper crypto technical background","Could question cross-functional leadership at this scale","Might want traditional institutional finance experience"],fitAnalysis:"Perfect match - regulatory experience from CTF, cross-functional leadership, institutional focus aligns with Grayscale background",activityLog:[],vibeHistory:[{date:"2025-09-18",vibe:"üòê",reason:"Initial assessment"}],fitScoreHistory:[{date:"2025-09-18",score:9.8,reason:"Initial assessment"}],dateAdded:"2025-09-18"},{id:"stripe-staff-pm-crypto",company:"Stripe",roleTitle:"Staff Product Manager - Crypto Infrastructure",jobUrl:"https://stripe.com/jobs/listing/staff-product-manager-crypto/7080962",location:"Remote (Global)",status:"not-started",vibe:"üòê",fitScore:9.7,salary:"$240k - $300k + equity",tags:["FinTech","Crypto","Remote","Infrastructure","Staff"],appliedDate:null,notes:"Global payments leader expanding crypto infrastructure post-Bridge acquisition. Strong developer ecosystem.",isArchived:!1,research:{companyIntel:"Leading payments platform, recently acquired Bridge for $1.1B, expanding stablecoin capabilities",keyPeople:["Patrick Collison (CEO)","John Collison (President)","Jeanne DeWitt Grosser (CFO)"],recentNews:"Bridge acquisition accelerating stablecoin strategy, expanding crypto payment rails globally",competitiveAdvantage:"Massive merchant network, developer ecosystem, global regulatory relationships",challenges:"Crypto-native competition, complex international regulations"},iceBreakers:["How does the Bridge acquisition change Stripe's crypto infrastructure strategy?","What regulatory challenges do you see in global stablecoin payments?","How do you balance merchant crypto demand with compliance requirements?"],objections:["May prefer deeper payments industry background","Could question global developer ecosystem experience","Might want more hands-on technical product management"],fitAnalysis:"Strong fit - payments infrastructure aligns with fintech experience, regulatory expertise highly valued",activityLog:[],vibeHistory:[{date:"2025-09-18",vibe:"üòê",reason:"Initial assessment"}],fitScoreHistory:[{date:"2025-09-18",score:9.7,reason:"Initial assessment"}],dateAdded:"2025-09-18"},{id:"circle-vp-product-usdc",company:"Circle",roleTitle:"VP Product - USDC Ecosystem",jobUrl:"https://careers.circle.com/us/en/c/product-jobs",location:"Boston, MA / Remote",status:"not-started",vibe:"üòê",fitScore:9.5,salary:"$275k - $350k + equity",tags:["Crypto","VP","Stablecoin","Ecosystem"],appliedDate:null,notes:"Leading stablecoin issuer focused on USDC ecosystem expansion and institutional adoption.",isArchived:!1,research:{companyIntel:"Major stablecoin issuer with $25B+ USDC in circulation, strong regulatory positioning",keyPeople:["Jeremy Allaire (CEO)","Dante Disparte (Chief Strategy Officer)"],recentNews:"Expanded USDC to multiple blockchains, strong institutional partnerships growth",competitiveAdvantage:"Regulatory leadership, institutional relationships, multi-chain strategy",challenges:"CBDC competition, regulatory shifts, market competition"},iceBreakers:["How is Circle positioning USDC against emerging CBDCs?","What's the strategy for multi-chain USDC deployment?","How do you see institutional vs retail USDC adoption evolving?"],objections:["May prefer more traditional payments experience","Could question blockchain technical depth","Might want more hands-on product development experience"],fitAnalysis:"Excellent fit - regulatory experience, institutional focus, fintech background aligns perfectly",activityLog:[],vibeHistory:[{date:"2025-09-18",vibe:"üòê",reason:"Initial assessment"}],fitScoreHistory:[{date:"2025-09-18",score:9.5,reason:"Initial assessment"}],dateAdded:"2025-09-18"}];function generateRemainingJobs(){let r=["Remote (Global)","Remote (US)","San Francisco, CA","New York, NY","Remote (EU/US)"],n=["üòê","üòê","üòê","üòä","üòü"],i={VP:"$260k - $350k + equity",Director:"$220k - $290k + equity",Head:"$240k - $320k + equity",Lead:"$200k - $270k + equity"};return[{company:"Polygon",role:"Director Product Strategy",url:"https://polygon.technology/careers",sector:"L1",score:8.9},{company:"Uniswap",role:"Head of Product - Protocol",url:"https://jobs.uniswap.org/",sector:"DeFi",score:8.7},{company:"Compound",role:"Director Product Management",url:"https://compound.finance/careers",sector:"DeFi",score:8.8},{company:"Chainlink",role:"VP Product Strategy",url:"https://chainlinklabs.com/careers",sector:"Oracle",score:9.1},{company:"Solana",role:"Director Product - Developer Experience",url:"https://jobs.solana.com/companies/solana-labs",sector:"L1",score:8.9},{company:"Avalanche",role:"Head of Product - Institutional",url:"https://avalabs.org/careers",sector:"L1",score:8.7},{company:"ConsenSys",role:"Director Product - Infura",url:"https://consensys.net/careers/",sector:"Infrastructure",score:8.5},{company:"Alchemy",role:"VP Product Platform",url:"https://www.alchemy.com/careers",sector:"Infrastructure",score:9},{company:"The Graph",role:"Director Product Strategy",url:"https://thegraph.com/careers/",sector:"Infrastructure",score:8.6},{company:"Kraken",role:"Director Product - Institutional",url:"https://www.kraken.com/careers",sector:"Exchange",score:8.8},{company:"Gemini",role:"VP Product Management",url:"https://www.gemini.com/careers",sector:"Exchange",score:9.2},{company:"Ripple",role:"Director Product - Enterprise",url:"https://ripple.com/careers/",sector:"Payments",score:8.4},{company:"MakerDAO",role:"Director Product Strategy",url:"https://makerdao.com/en/careers",sector:"DeFi",score:8.3},{company:"Aave",role:"VP Product Development",url:"https://aave.com/careers/",sector:"DeFi",score:8.7},{company:"Binance US",role:"Director Product Management",url:"https://www.binance.us/careers",sector:"Exchange",score:8.1},{company:"dYdX",role:"Head of Product - Trading",url:"https://dydx.careers/",sector:"DeFi",score:8.5},{company:"Opensea",role:"Director Product Strategy",url:"https://opensea.io/careers",sector:"NFT",score:7.9},{company:"OpenAI",role:"Lead Product Manager - Core Product",url:"https://openai.com/careers/",sector:"AI",score:9.8},{company:"Anthropic",role:"Product Manager - Research Commercialization",url:"https://www.anthropic.com/careers",sector:"AI",score:9.5},{company:"Scale AI",role:"Product Manager - Gen AI Platform",url:"https://scale.com/careers",sector:"AI",score:8.9},{company:"Cohere",role:"Director Product Strategy",url:"https://cohere.com/careers",sector:"AI",score:8.7},{company:"Stability AI",role:"Head of Product - Enterprise",url:"https://stability.ai/careers",sector:"AI",score:8.4},{company:"Hugging Face",role:"VP Product Strategy",url:"https://huggingface.co/jobs",sector:"AI",score:8.8},{company:"Midjourney",role:"Director Product Management",url:"https://www.midjourney.com/jobs",sector:"AI",score:8.2},{company:"Runway",role:"Head of Product - Creative Tools",url:"https://runwayml.com/careers/",sector:"AI",score:8.5},{company:"Character.AI",role:"Director Product Strategy",url:"https://character.ai/careers",sector:"AI",score:8.1},{company:"Replicate",role:"VP Product Platform",url:"https://replicate.com/jobs",sector:"AI",score:8.6},{company:"LangChain",role:"Director Product - Enterprise",url:"https://www.langchain.com/careers",sector:"AI",score:8.3},{company:"Pinecone",role:"Head of Product - Vector Database",url:"https://www.pinecone.io/careers/",sector:"AI",score:8.7},{company:"Together AI",role:"Director Product Strategy",url:"https://www.together.ai/careers",sector:"AI",score:8.4},{company:"Modal",role:"VP Product Platform",url:"https://modal.com/careers",sector:"AI",score:8.5},{company:"Weights & Biases",role:"Director Product Management",url:"https://wandb.ai/company/careers",sector:"AI",score:8.8},{company:"Plaid",role:"Director Product - Financial Institutions",url:"https://plaid.com/careers/",sector:"FinTech",score:9.3},{company:"Mercury",role:"VP Product Strategy",url:"https://mercury.com/careers",sector:"FinTech",score:9},{company:"Ramp",role:"Director Product Management",url:"https://ramp.com/careers",sector:"FinTech",score:8.8},{company:"Brex",role:"Head of Product - Corporate Cards",url:"https://www.brex.com/careers/",sector:"FinTech",score:8.9},{company:"Chime",role:"Director Product Strategy",url:"https://www.chime.com/careers/",sector:"FinTech",score:8.2},{company:"Affirm",role:"VP Product - Merchant Platform",url:"https://www.affirm.com/careers",sector:"FinTech",score:8.5},{company:"Block",role:"Director Product - Seller Platform",url:"https://careers.block.xyz/",sector:"FinTech",score:8.7},{company:"Robinhood",role:"Head of Product - Investing",url:"https://robinhood.com/careers/",sector:"FinTech",score:8.4},{company:"Nubank",role:"Director Product - International",url:"https://international.nubank.com.br/careers/",sector:"FinTech",score:8.1},{company:"Klarna",role:"VP Product Strategy",url:"https://www.klarna.com/careers/",sector:"FinTech",score:8.3},{company:"Checkout.com",role:"Director Product Management",url:"https://www.checkout.com/careers",sector:"FinTech",score:8.6},{company:"Wise",role:"Head of Product - Business",url:"https://wise.jobs/",sector:"FinTech",score:8.8},{company:"Revolut",role:"Director Product Strategy",url:"https://www.revolut.com/careers/",sector:"FinTech",score:8},{company:"Monzo",role:"VP Product Development",url:"https://monzo.com/careers/",sector:"FinTech",score:8.2},{company:"N26",role:"Director Product Management",url:"https://careers.n26.com/",sector:"FinTech",score:7.9}].map((e,t)=>{var a=e.role.split(" ")[0],o=i[a]||"$230k - $300k + equity";return{id:e.company.toLowerCase().replace(/[^a-z0-9]/g,"-")+"-"+t,company:e.company,roleTitle:e.role,jobUrl:e.url,location:r[t%r.length],status:"not-started",vibe:n[t%n.length],fitScore:e.score,salary:o,tags:["Remote",e.sector,a,"Product","Strategy"].slice(0,4),appliedDate:null,notes:e.company+` is a leading ${e.sector} company with strong market position and growth trajectory.`,isArchived:!1,research:{companyIntel:e.company+` is well-positioned in the ${e.sector} space with strong leadership and market presence.`,keyPeople:["CEO","CTO","Head of Product"],recentNews:`Recent product launches and funding rounds driving growth in ${e.sector} market.`,competitiveAdvantage:"Strong technical team, market-leading products, and solid regulatory positioning.",challenges:"Competitive market dynamics and evolving regulatory landscape."},iceBreakers:[`How is ${e.company} approaching the current market conditions in ${e.sector}?`,"What are the key technical challenges you're solving?","How do you see the competitive landscape evolving?"],objections:["May prefer candidates with more industry-specific experience","Could question technical depth in the domain","Might want more hands-on product management experience"],fitAnalysis:`${9<=e.score?"Excellent":8.5<=e.score?"Strong":"Good"} fit - aligns well with background and career progression goals.`,activityLog:[],vibeHistory:[{date:"2025-09-18",vibe:n[t%n.length],reason:"Initial assessment"}],fitScoreHistory:[{date:"2025-09-18",score:e.score,reason:"Initial assessment"}],dateAdded:"2025-09-18"}})}let jobsData=[...initialJobsData,...generateRemainingJobs()],currentView="home",filteredJobs=[...jobsData],selectedJobs=new Set,currentFilters={status:[],fitScore:0,vibe:[],search:"",needsReview:!1},sortConfig={key:null,direction:"asc"},charts={},draggedElement=null,currentEditingJob=null,goals={targetOffers:5,timelineWeeks:6,interviewRate:30,offerRate:25,startDate:"2025-09-18"},masterActivityLog=[],lensPresets=[{id:"pattern",name:"Pattern: Top-fit AI/Crypto",mode:"filter",color:"#3B82F6",include:[{all:[{field:"fitScore",gte:8.5},{field:"tags",includesAny:["AI","Crypto"]}]}],exclude:[{field:"status",equals:"rejected"}]},{id:"pacing",name:"Pacing: This Week",mode:"filter",color:"#6366F1",include:[],exclude:[]},{id:"bias",name:"Bias: NYC/Onsite",mode:"highlight",color:"#EAB308",include:[{any:[{field:"location",matches:"NYC|New York"},{field:"tags",includesAny:["Onsite"]}]}],exclude:[]},{id:"platform",name:"Platform: Greenhouse/Lever",mode:"filter",color:"#10B981",include:[{any:[{field:"jobDomain",includes:"greenhouse.io"},{field:"jobDomain",includes:"lever.co"}]}],exclude:[]}],activeLensId="none",customLens={id:"custom",name:"Custom",mode:"filter",include:[],exclude:[]},promptLens=null,kanbanSort={key:"fit",dir:"desc"},discoveryQueue=[],discoveryIndex=0,YES_REASONS=["great_fit","domain_match","remote_ok","comp_band","impact_scope","referral_possible"],NO_REASONS=["level_mismatch","onsite_only","domain_misfit","comp_low","legacy_stack","too_early_late"],selectedYesReasons=new Set,selectedNoReasons=new Set,discoveryHistory=[],segmentMinN=5,discoverExplorePct=10,discoverAutoAccept=!0,discoverFitMin=8,discoverStreak=0,discoverCount=0,discoverTotal=0,discoverSessionRemaining=0;function initializeApp(){loadDataFromStorage(),loadLensStateFromStorage(),loadKanbanSortFromStorage(),loadAnalyticsSettingsFromStorage(),loadDiscoverSettingsFromStorage(),filteredJobs=jobsData.filter(e=>!e.isArchived),bindEventListeners(),renderDashboard(),renderGoalsSection(),renderCurrentView(),updateLensIndicator(),updateKanbanSortUI(),bindAnalyticsControls(),bindDiscoverControls(),initializeMasterActivityLog(),console.log("Job Search Optimizer initialized with",jobsData.length,"roles")}function saveDataToStorage(){try{localStorage.setItem("jobSearchData",JSON.stringify(jobsData)),localStorage.setItem("jobSearchFilters",JSON.stringify(currentFilters)),localStorage.setItem("jobSearchGoals",JSON.stringify(goals)),localStorage.setItem("masterActivityLog",JSON.stringify(masterActivityLog)),localStorage.setItem("lensActive",activeLensId),localStorage.setItem("lensCustom",JSON.stringify(customLens)),console.log("Data saved to localStorage")}catch(e){console.error("Failed to save data to localStorage:",e),showToast("Failed to save data","error")}}function loadDataFromStorage(){try{var e,t=localStorage.getItem("jobSearchData"),a=localStorage.getItem("jobSearchFilters"),o=localStorage.getItem("jobSearchGoals"),r=localStorage.getItem("masterActivityLog");t&&(e=JSON.parse(t))&&40<=e.length&&(jobsData=e,console.log("Loaded",jobsData.length,"jobs from localStorage")),a&&(currentFilters={...currentFilters,...JSON.parse(a)}),o&&(goals={...goals,...JSON.parse(o)}),r&&(masterActivityLog=JSON.parse(r))}catch(e){console.error("Failed to load data from localStorage:",e)}}function loadLensStateFromStorage(){try{var e=localStorage.getItem("lensActive"),t=(e&&(activeLensId=e),localStorage.getItem("lensCustom")),a=(t&&(customLens={...customLens,...JSON.parse(t)}),localStorage.getItem("lensPrompt"));if(a)try{promptLens=JSON.parse(a)}catch(e){promptLens=null}}catch(e){console.warn("Failed to load lenses state:",e)}}function bindEventListeners(){document.querySelectorAll(".view-btn").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault();e=t.dataset.view;e&&switchView(e)})}),bindHeaderActions(),bindSearchAndFilters(),bindBulkActions(),bindModalHandlers(),bindTableSorting();var e=document.getElementById("review-accept-selected"),t=document.getElementById("review-reject-selected"),a=document.getElementById("review-clear-flags"),e=(e&&e.addEventListener("click",acceptSelectedReviews),t&&t.addEventListener("click",rejectSelectedReviews),a&&a.addEventListener("click",clearReviewFlags),bindKanbanSort(),document.getElementById("pipeline-review-shortcut"));e&&e.addEventListener("click",e=>{e.preventDefault(),currentFilters.needsReview=!0,updateFilterIndicator(),switchView("table"),applyAllFilters(),showToast("Showing Needs Review list","info")}),document.addEventListener("keydown",e=>{if("discover"===currentView){var t=e.target&&e.target.tagName||"";if("INPUT"!==t&&"TEXTAREA"!==t)if("ArrowRight"===e.key){t=discoveryQueue[discoveryIndex];t&&handleDiscoverLabel(1,t)}else if("ArrowLeft"===e.key){t=discoveryQueue[discoveryIndex];t&&handleDiscoverLabel(0,t)}else if(" "===e.key){e.preventDefault();t=discoveryQueue[discoveryIndex];t&&handleDiscoverLabel(null,t)}else if("z"===e.key.toLowerCase())try{undoDiscover()}catch(e){console.error(e)}}})}function bindAnalyticsControls(){let t=document.getElementById("segment-min-n");t&&(t.value=String(segmentMinN),t.addEventListener("change",()=>{var e=parseInt(t.value)||5;segmentMinN=Math.max(1,Math.min(100,e)),saveAnalyticsSettingsToStorage(),"analytics"===currentView&&renderAnalyticsView()}))}function saveAnalyticsSettingsToStorage(){try{localStorage.setItem("analyticsSettings",JSON.stringify({segmentMinN:segmentMinN}))}catch(e){console.warn("save analytics settings failed")}}function loadAnalyticsSettingsFromStorage(){try{var e=JSON.parse(localStorage.getItem("analyticsSettings")||"{}");e&&"number"==typeof e.segmentMinN&&(segmentMinN=e.segmentMinN)}catch(e){}}function bindDiscoverControls(){let e=document.getElementById("discover-explore"),t=document.getElementById("discover-explore-label"),a=(e&&t&&(e.value=String(discoverExplorePct),t.textContent=discoverExplorePct+"%",e.addEventListener("input",()=>{discoverExplorePct=parseInt(e.value)||0,t.textContent=discoverExplorePct+"%",saveDiscoverSettingsToStorage()})),document.getElementById("discover-auto-accept")),o=document.getElementById("discover-fit-min");a&&(a.checked=!!discoverAutoAccept,a.addEventListener("change",()=>{discoverAutoAccept=a.checked,saveDiscoverSettingsToStorage()})),o&&(o.value=String(discoverFitMin),o.addEventListener("change",()=>{var e=parseFloat(o.value);discoverFitMin=isNaN(e)?8:Math.max(0,Math.min(10,e)),saveDiscoverSettingsToStorage()})),updateDiscoverHUD()}function updateDiscoverHUD(){var e=document.getElementById("discover-streak"),t=document.getElementById("discover-progress");e&&(e.textContent="Streak "+discoverStreak),t&&(t.textContent=discoverCount+"/"+discoverTotal)}function saveDiscoverSettingsToStorage(){try{localStorage.setItem("discoverSettings",JSON.stringify({discoverExplorePct:discoverExplorePct,discoverAutoAccept:discoverAutoAccept,discoverFitMin:discoverFitMin}))}catch(e){}}function loadDiscoverSettingsFromStorage(){try{var e=JSON.parse(localStorage.getItem("discoverSettings")||"{}");e&&("number"==typeof e.discoverExplorePct&&(discoverExplorePct=e.discoverExplorePct),"boolean"==typeof e.discoverAutoAccept&&(discoverAutoAccept=e.discoverAutoAccept),"number"==typeof e.discoverFitMin)&&(discoverFitMin=e.discoverFitMin)}catch(e){}}function bindKanbanSort(){var e=document.getElementById("kanban-sort-select");e&&(e.value=kanbanSort.key+"-"+kanbanSort.dir,e.addEventListener("change",e=>{var[e,t]=(e.target.value||"fit-desc").split("-");kanbanSort={key:e,dir:t},saveKanbanSortToStorage(),"kanban"===currentView&&renderKanbanView()}))}function updateKanbanSortUI(){var e=document.getElementById("kanban-sort-wrap"),t=document.getElementById("kanban-sort-select");e&&(e.style.display="kanban"===currentView?"flex":"none"),t&&(t.value=kanbanSort.key+"-"+kanbanSort.dir)}function saveKanbanSortToStorage(){try{localStorage.setItem("kanbanSort",JSON.stringify(kanbanSort))}catch(e){console.warn("kanbanSort save failed")}}function loadKanbanSortFromStorage(){try{var e,t=localStorage.getItem("kanbanSort");t&&(e=JSON.parse(t))&&e.key&&e.dir&&(kanbanSort=e)}catch(e){console.warn("kanbanSort load failed")}}function bindHeaderActions(){var e=document.getElementById("goals-btn"),e=(e&&e.addEventListener("click",e=>{e.preventDefault(),showGoalsModal()}),document.getElementById("activity-log-btn")),e=(e&&e.addEventListener("click",e=>{e.preventDefault(),showMasterActivityLog()}),document.getElementById("archive-btn")),e=(e&&e.addEventListener("click",e=>{e.preventDefault(),switchView("archive")}),document.getElementById("import-btn"));let t=document.getElementById("csv-import-input");e&&t&&(e.addEventListener("click",e=>{e.preventDefault(),t.click()}),t.addEventListener("change",handleCSVImport));e=document.getElementById("export-btn"),e&&e.addEventListener("click",e=>{e.preventDefault(),handleExport()}),e=document.getElementById("export-bundle-btn"),e&&e.addEventListener("click",async e=>{e.preventDefault();try{await handleExportBundle()}catch(e){console.error(e),showToast("Bundle export failed","error")}}),e=document.getElementById("open-schema-report-btn"),e&&e.addEventListener("click",e=>{e.preventDefault(),window.__lastSchemaReport?showSchemaReport(window.__lastSchemaReport):showToast("No validation report yet","error")}),e=document.getElementById("home-start-triage");e&&e.addEventListener("click",e=>{e.preventDefault(),startTriageSession(10)})}function bindSearchAndFilters(){var e=document.getElementById("search-input"),e=(e&&e.addEventListener("input",handleSearch),document.getElementById("filter-btn"));e&&e.addEventListener("click",e=>{e.preventDefault(),toggleFilters()});let t=document.getElementById("needs-review-btn");t&&t.addEventListener("click",e=>{e.preventDefault(),currentFilters.needsReview=!currentFilters.needsReview,t.classList.toggle("active",currentFilters.needsReview),applyAllFilters(),updateFilterIndicator(),saveDataToStorage()});e=document.getElementById("lenses-btn"),e&&e.addEventListener("click",e=>{e.preventDefault(),openLensesModal()}),e=document.getElementById("apply-filters-btn"),e&&e.addEventListener("click",e=>{e.preventDefault(),applyFilters()}),e=document.getElementById("clear-filters-btn"),e&&e.addEventListener("click",e=>{e.preventDefault(),clearFilters()}),e=document.getElementById("fit-score-range");e&&e.addEventListener("input",updateFitScoreLabel)}function bindBulkActions(){var e=document.getElementById("select-all"),e=(e&&e.addEventListener("change",handleSelectAll),document.getElementById("bulk-apply-btn")),e=(e&&e.addEventListener("click",e=>{e.preventDefault(),handleBulkApply()}),document.getElementById("bulk-clear-btn"));e&&e.addEventListener("click",e=>{e.preventDefault(),clearBulkSelection()})}function bindModalHandlers(){document.querySelectorAll(".modal-close, .modal-overlay").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),closeModals()})}),document.querySelectorAll(".modal-content").forEach(e=>{e.addEventListener("click",e=>{e.stopPropagation()})});var e=document.getElementById("modal-save"),e=(e&&e.addEventListener("click",saveJobChanges),document.getElementById("goals-save"));e&&e.addEventListener("click",saveGoals),["goal-offers-input","goal-timeline-input","goal-interview-rate","goal-offer-rate"].forEach(e=>{e=document.getElementById(e);e&&e.addEventListener("input",updateGoalsCalculation)})}function bindTableSorting(){document.querySelectorAll(".sortable").forEach(a=>{a.addEventListener("click",e=>{var t=a.dataset.sort;t&&handleSort(t)})})}function handleCSVImport(e){var t,e=e.target.files[0];e&&((t=new FileReader).onload=e=>{try{showImportResults(parseCSV(e.target.result))}catch(e){console.error("CSV parsing error:",e),showToast("Failed to parse CSV file","error")}},t.readAsText(e))}function parseCSV(e){var a=e.trim().split("\n");if(a.length<2)throw new Error("CSV must have at least a header row and one data row");var r,n=a[0].split(",").map(e=>e.trim().replace(/"/g,"")),i=[],s=[];let l=0;for(let t=1;t<a.length;t++)try{let o=parseCSVLine(a[t]);if(o.length!==n.length)s.push(`Row ${t+1}: Column count mismatch`);else{let a={};n.forEach((e,t)=>{a[e.toLowerCase().replace(/\s+/g,"")]=o[t]}),jobsData.find(e=>e.company.toLowerCase()===(a.company||"").toLowerCase()&&e.roleTitle.toLowerCase()===(a.role||a.roletitle||"").toLowerCase())?l++:(r=createJobFromCSV(a))&&(jobsData.push(r),i.push(r),addToMasterActivityLog("Import",`Imported ${r.company} - `+r.roleTitle,r.id))}}catch(e){s.push(`Row ${t+1}: `+e.message)}return 0<i.length&&(saveDataToStorage(),applyAllFilters(),renderDashboard(),renderCurrentView()),{imported:i.length,errors:s,skipped:l}}function parseCSVLine(t){var a=[];let o="",r=!1;for(let e=0;e<t.length;e++){var n=t[e],i=t[e+1];'"'===n?r&&'"'===i?(o+='"',e++):r=!r:","!==n||r?o+=n:(a.push(o.trim()),o="")}return a.push(o.trim()),a}function createJobFromCSV(e){var t=e.company||"",a=e.role||e.roletitle||"";if(t&&a)return{id:`imported-${t.toLowerCase().replace(/[^a-z0-9]/g,"-")}-`+Date.now(),company:t,roleTitle:a,jobUrl:e.joburl||e.url||`https://${t.toLowerCase().replace(/\s+/g,"")}.com/careers`,location:e.location||"Remote",status:e.status||"not-started",vibe:e.vibe||"üòê",fitScore:parseFloat(e.fitscore||e.fit)||7,salary:e.salary||"$200k - $300k",tags:(e.tags||"Product,Remote").split(/[;,]/).map(e=>e.trim()).filter(e=>e),appliedDate:e.applieddate||null,notes:e.notes||"",isArchived:!1,research:{companyIntel:e.companyintel||t+" research pending",keyPeople:[],recentNews:e.recentnews||"Recent news to be researched",competitiveAdvantage:"Competitive analysis pending",challenges:"Challenge analysis pending"},iceBreakers:[],objections:[],fitAnalysis:e.fitanalysis||"Fit analysis to be completed",activityLog:[],vibeHistory:[{date:(new Date).toISOString().split("T")[0],vibe:e.vibe||"üòê",reason:"Imported from CSV"}],fitScoreHistory:[{date:(new Date).toISOString().split("T")[0],score:parseFloat(e.fitscore||e.fit)||7,reason:"Imported from CSV"}],dateAdded:(new Date).toISOString().split("T")[0]};throw new Error("Company and Role are required fields")}function showImportResults(e){let t=document.getElementById("import-result-modal");var a,o,r=document.getElementById("import-result-body");t&&r&&({imported:e,errors:a,skipped:o}=e,r.innerHTML=`
    <div class="import-result-summary">
      <div class="import-stat">
        <div class="import-stat-value">${e}</div>
        <div class="import-stat-label">Imported</div>
      </div>
      <div class="import-stat">
        <div class="import-stat-value">${o}</div>
        <div class="import-stat-label">Skipped</div>
      </div>
      <div class="import-stat">
        <div class="import-stat-value">${a.length}</div>
        <div class="import-stat-label">Errors</div>
      </div>
    </div>
    
    ${0<a.length?`
      <h4>Import Errors:</h4>
      <div class="import-errors">
        ${a.map(e=>`<div class="import-error">${e}</div>`).join("")}
      </div>
    `:""}
    
    <p><strong>Import completed successfully!</strong> ${e} jobs were added to your pipeline.</p>
  `,t.classList.remove("hidden"),(r=document.getElementById("import-result-ok"))&&r.addEventListener("click",()=>{t.classList.add("hidden")}),showToast(`Imported ${e} jobs successfully`,"success"))}function showGoalsModal(){var e=document.getElementById("goals-modal");e&&(document.getElementById("goal-offers-input").value=goals.targetOffers,document.getElementById("goal-timeline-input").value=goals.timelineWeeks,document.getElementById("goal-interview-rate").value=goals.interviewRate,document.getElementById("goal-offer-rate").value=goals.offerRate,updateGoalsCalculation(),e.classList.remove("hidden"))}function updateGoalsCalculation(){var e=parseInt(document.getElementById("goal-offers-input")?.value)||5,t=parseInt(document.getElementById("goal-timeline-input")?.value)||6,a=parseInt(document.getElementById("goal-interview-rate")?.value)||30,o=parseInt(document.getElementById("goal-offer-rate")?.value)||25,o=Math.ceil(e/(o/100)),a=Math.ceil(o/(a/100)),t=Math.ceil(a/t),r=document.getElementById("goals-recommendation-text"),r=(r&&(r.innerHTML=`
      Based on your conversion rates, you should:<br>
      ‚Ä¢ Apply to <strong>${a} roles total</strong><br>
      ‚Ä¢ Target <strong>${t} applications per week</strong><br>
      ‚Ä¢ Expect <strong>${o} interviews</strong> to achieve <strong>${e} offers</strong>
    `),document.getElementById("lenses-apply")),a=(r&&r.addEventListener("click",applyLensSelection),document.getElementById("lenses-cancel")),t=(a&&a.addEventListener("click",closeModals),document.getElementById("lenses-close")),o=(t&&t.addEventListener("click",closeModals),document.getElementById("lenses-save-prompt"));o&&o.addEventListener("click",savePromptLens)}function saveGoals(){goals={targetOffers:parseInt(document.getElementById("goal-offers-input")?.value)||5,timelineWeeks:parseInt(document.getElementById("goal-timeline-input")?.value)||6,interviewRate:parseInt(document.getElementById("goal-interview-rate")?.value)||30,offerRate:parseInt(document.getElementById("goal-offer-rate")?.value)||25,startDate:goals.startDate},saveDataToStorage(),renderGoalsSection(),closeModals(),addToMasterActivityLog("Goals",`Updated goals: ${goals.targetOffers} offers in ${goals.timelineWeeks} weeks`),showToast("Goals updated successfully","success")}function renderGoalsSection(){var e=Math.ceil((new Date-new Date(goals.startDate))/6048e5)+1,t=Math.min(e/goals.timelineWeeks*100,100),a=calculateDashboardStats(),o=Math.ceil(goals.targetOffers/(goals.interviewRate/100*(goals.offerRate/100))),r=Math.ceil(o/goals.timelineWeeks),n=Math.max(goals.timelineWeeks-e+1,0),o=0<n?Math.ceil((o-a.applied)/n):0,e=(document.getElementById("goals-title").textContent=`Goal: ${goals.targetOffers} offers in ${goals.timelineWeeks} weeks`,document.getElementById("goals-progress").textContent=`Week ${e} of `+goals.timelineWeeks,document.getElementById("goals-recommendation").textContent=0<n?`Recommended: ${Math.max(o,0)} more applications this week`:"Goal period completed",document.getElementById("goal-offers").textContent=a.offers,document.getElementById("goal-pipeline").textContent=a.interviewing+a.applied,document.getElementById("goals-progress-bar")),n=(e&&(e.style.width=t+"%"),document.getElementById("pacing-now")),a=(n&&(n.textContent=String(Math.max(o,0))),document.getElementById("pacing-weekly-target"));a&&(a.textContent=`Target: ${r}/wk`)}function initializeMasterActivityLog(){0===masterActivityLog.length&&addToMasterActivityLog("System","Job Search Optimizer initialized with 50 roles")}function addToMasterActivityLog(e,t,a=null){e={id:Date.now(),date:(new Date).toISOString(),type:e,description:t,jobId:a};masterActivityLog.unshift(e),1e3<masterActivityLog.length&&(masterActivityLog=masterActivityLog.slice(0,1e3)),saveDataToStorage()}function showMasterActivityLog(){var e=document.getElementById("master-activity-modal");e&&(updateActivityStats(),renderMasterActivityTimeline(),renderAchievements(),e.classList.remove("hidden"))}function updateActivityStats(){var e=masterActivityLog.length;let t=new Date;t.setDate(t.getDate()-7);var a=masterActivityLog.filter(e=>new Date(e.date)>=t).length,o=Math.min(100,Math.floor(a/20*100));document.getElementById("total-activities").textContent=e,document.getElementById("this-week-activities").textContent=a,document.getElementById("productivity-score").textContent=o}function renderMasterActivityTimeline(){var e,t=document.getElementById("master-activity-timeline");t&&(e=masterActivityLog.slice(0,50),t.innerHTML=e.map(t=>{var e=t.jobId?jobsData.find(e=>e.id===t.jobId):null,a=e?e.company+" - "+e.roleTitle:"";return`
      <div class="activity-item">
        <div class="activity-date">${formatDate(t.date.split("T")[0])}</div>
        <div class="activity-content">
          <div class="activity-type">${t.type}</div>
          <div class="activity-note">
            ${e?`<span class="activity-company">${a}</span>`:""}
            ${t.description}
          </div>
        </div>
      </div>
    `}).join(""))}function renderAchievements(){var e,t=document.getElementById("activity-achievements");t&&(e=calculateAchievements(),t.innerHTML=e.map(e=>`<span class="achievement-badge">${e}</span>`).join(""))}function calculateAchievements(){var e=[],t=jobsData.filter(e=>"not-started"!==e.status).length,a=jobsData.filter(e=>"offer"===e.status).length,t=(10<=t&&e.push("üöÄ Active Searcher"),25<=t&&e.push("‚≠ê Pipeline Builder"),1<=a&&e.push("üèÜ First Offer"),3<=a&&e.push("üíé Multiple Offers"),masterActivityLog.filter(e=>{var t=new Date;return t.setDate(t.getDate()-7),new Date(e.date)>=t}).length);return 10<=t&&e.push("üî• High Activity"),20<=t&&e.push("‚ö° Power User"),e}function handleBulkApply(){var e=document.getElementById("bulk-status-select"),t=document.getElementById("bulk-vibe-select");let r=e?.value,n=t?.value;if(r||n){let o=0;selectedJobs.forEach(t=>{var e,a=jobsData.find(e=>e.id===t);a&&(r&&a.status!==r&&(e=a.status,"applied"!==(a.status=r)||a.appliedDate||(a.appliedDate=(new Date).toISOString().split("T")[0]),a.activityLog.push({date:(new Date).toISOString().split("T")[0],type:"Bulk Update",note:`Status changed from ${formatStatus(e)} to ${formatStatus(r)} via bulk action`}),addToMasterActivityLog("Bulk Update",a.company+" status changed to "+formatStatus(r),a.id),o++),n)&&a.vibe!==n&&(e=a.vibe,a.vibe=n,a.vibeHistory.push({date:(new Date).toISOString().split("T")[0],vibe:n,reason:"Bulk update"}),a.activityLog.push({date:(new Date).toISOString().split("T")[0],type:"Vibe Update",note:`Vibe changed from ${e} to ${n} via bulk action`}),addToMasterActivityLog("Bulk Update",a.company+" vibe updated to "+n,a.id),o++)}),0<o&&(clearBulkSelection(),saveDataToStorage(),applyAllFilters(),renderDashboard(),renderCurrentView(),showToast(`Updated ${o} jobs`,"success"))}else showToast("Please select a status or vibe to apply","error")}function clearBulkSelection(){selectedJobs.clear();var e=document.getElementById("bulk-status-select"),t=document.getElementById("bulk-vibe-select");e&&(e.value=""),t&&(t.value=""),updateBulkActions(),renderCurrentView()}function archiveJob(t){var e=jobsData.find(e=>e.id===t);e&&(e.isArchived=!0,e.archivedDate=(new Date).toISOString().split("T")[0],e.archivedReason="offer"===e.status?"Completed - Offer accepted":"rejected"===e.status?"Rejected by company":"Manually archived",e.activityLog.push({date:e.archivedDate,type:"Archived",note:e.archivedReason}),addToMasterActivityLog("Archive",`${e.company} - ${e.roleTitle} archived: `+e.archivedReason,e.id),saveDataToStorage(),applyAllFilters(),renderDashboard(),renderCurrentView(),showToast(e.company+" archived","success"))}function restoreJob(t){var e=jobsData.find(e=>e.id===t);e&&(e.isArchived=!1,delete e.archivedDate,delete e.archivedReason,e.activityLog.push({date:(new Date).toISOString().split("T")[0],type:"Restored",note:"Job restored from archive"}),addToMasterActivityLog("Restore",`${e.company} - ${e.roleTitle} restored from archive`,e.id),saveDataToStorage(),applyAllFilters(),renderDashboard(),renderCurrentView(),showToast(e.company+" restored","success"))}function renderArchiveView(){var e,t=document.getElementById("archive-table-body");t&&(e=jobsData.filter(e=>e.isArchived),t.innerHTML=e.map(e=>`
    <tr>
      <td class="company-cell">
        <a href="${e.jobUrl}" target="_blank">${e.company}</a>
      </td>
      <td>${e.roleTitle}</td>
      <td>${formatDate(e.archivedDate)}</td>
      <td>${e.archivedReason||"Unknown"}</td>
      <td class="actions-cell">
        <button class="action-btn" onclick="restoreJob('${e.id}')" title="Restore">
          <i class="fas fa-undo"></i>
        </button>
        <button class="action-btn" onclick="viewJobDetails('${e.id}')" title="View Details">
          <i class="fas fa-eye"></i>
        </button>
      </td>
    </tr>
  `).join(""))}function switchView(t){var e,a;currentView!==t&&(currentView=t,document.querySelectorAll(".view-btn").forEach(e=>{e.classList.toggle("active",e.dataset.view===t)}),e=(e,t)=>{e=document.getElementById(e);e&&e.classList.toggle("active",!!t)},(a=document.querySelector(".dashboard-section"))&&(a.style.display="home"===t?"":"none"),e("table-view","table"===t),e("discover-view","triage"===t),e("kanban-view","pipeline"===t),e("analytics-view","insights"===t),e("archive-view","archive"===t),"archive"===t?filteredJobs=jobsData.filter(e=>e.isArchived):(filteredJobs=jobsData.filter(e=>!e.isArchived),applyAllFilters()),renderCurrentView(),selectedJobs.clear(),updateBulkActions(),updateKanbanSortUI(),"discover"===t)&&buildDiscoveryQueue()}function renderCurrentView(){switch(currentView){case"table":renderTableView();break;case"kanban":renderKanbanView();break;case"discover":renderDiscoverView();break;case"analytics":renderAnalyticsView();break;case"archive":renderArchiveView()}}function buildDiscoveryQueue(){(discoveryQueue=jobsData.filter(e=>!e.isArchived&&"not-started"===e.status)).sort((e,t)=>(parseFloat(t.fitScore)||0)-(parseFloat(e.fitScore)||0)),discoveryIndex=Math.min(discoveryIndex,Math.max(0,discoveryQueue.length-1))}function renderDiscoverView(){var o=document.getElementById("discover-card"),r=document.getElementById("discover-status");if(o){var n,i,s=document.getElementById("discover-gear");let e=document.getElementById("discover-controls"),t=(s&&e&&(s.onclick=()=>{e.style.display="none"===e.style.display?"flex":"none"}),0===discoveryQueue.length&&buildDiscoveryQueue(),pickDiscoverJob()),a=t?.job;a?(s=getJobDomain(a.jobUrl),o.innerHTML=`
    <div class="company">${a.company} ‚Ä¢ <span class="meta">${s}</span> ${t?.novel?'<span class="badge">Novel</span>':""}</div>
    <div class="title">${a.roleTitle}</div>
    <div class="meta">${a.location||""} ‚Ä¢ Fit ${a.fitScore}${0<discoverSessionRemaining?" ‚Ä¢ "+discoverSessionRemaining+" left":""}</div>
    <div class="link"><a href="${normalizeUrl(a.jobUrl)}" target="_blank" rel="noopener">Open posting</a></div>
  `,renderReasonChips("reasons-yes",YES_REASONS,selectedYesReasons),renderReasonChips("reasons-no",NO_REASONS,selectedNoReasons),s=document.getElementById("discover-yes"),n=document.getElementById("discover-no"),i=document.getElementById("discover-skip"),s&&(s.onclick=()=>handleDiscoverLabel(1,a,t?.index,t?.novel)),n&&(n.onclick=()=>handleDiscoverLabel(0,a,t?.index,t?.novel)),i&&(i.onclick=()=>handleDiscoverLabel(null,a,t?.index,t?.novel)),(s=document.getElementById("discover-undo"))&&(s.onclick=function(){try{undoDiscover()}catch(e){console.error(e)}}),renderDiscoverSuggestion()):(o.innerHTML='<div class="company">All caught up</div><div class="meta">No more roles in Not Started.</div>',r&&(r.textContent=""))}}function renderReasonChips(e,t,a){e=document.getElementById(e);e&&(e.innerHTML=t.map(e=>{var t=e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase());return`<span class="chip ${a.has(e)?"selected":""}" data-k="${e}">${t}</span>`}).join(""),e.querySelectorAll(".chip").forEach(t=>{t.addEventListener("click",()=>{var e=t.dataset.k;e&&(a.has(e)?a.delete(e):a.add(e),t.classList.toggle("selected"))})}))}function handleDiscoverLabel(e,t,a,o){var r=1===e?Array.from(selectedYesReasons):0===e?Array.from(selectedNoReasons):[],n=logDiscoveryFeedback(t,e,r);try{var i=getModelState(),s=extractFeatures(t),l=(updateModelWithFeedback(e,s,r),computeFit(s)),c=t.fitScore;t.fitScore=parseFloat(l.toFixed(1)),t.fit={score:t.fitScore,conf:t.fit?.conf||.5,model_version:"v0.2.1"},discoveryHistory.push({jobId:t.id,label:e,reasons:r,evtId:n?.id,prevModel:i,prevFit:c,index:discoveryIndex})}catch(e){console.warn("model update failed",e)}selectedYesReasons.clear(),selectedNoReasons.clear(),"number"==typeof a&&null!==e&&discoveryQueue.splice(a,1),1===e?discoverAutoAccept&&(parseFloat(t.fitScore)||0)>=discoverFitMin?(discoverStreak+=1,showToast("Added to backlog ‚úì","success"),"function"==typeof confetti&&discoverStreak%5==0&&confetti({particleCount:80,spread:60,origin:{y:.6}})):(t.needsReview=!0,discoverStreak=0,showToast("Queued for review","info")):0===e&&(discoverStreak=0),discoverCount+=1,0<discoverSessionRemaining&&--discoverSessionRemaining,updateDiscoverHUD(),0===discoverSessionRemaining&&null!==e&&showToast("Triage session complete","success"),saveDataToStorage(),renderDashboard(),applyAllFilters(),renderDiscoverView()}function pickDiscoverJob(){if(0===discoveryQueue.length)return null;var e=Math.random()<discoverExplorePct/100;let t=0;return t=e?Math.floor(Math.random()*discoveryQueue.length):0,{job:discoveryQueue[t],index:t,novel:e}}function renderDiscoverSuggestion(){let t=document.getElementById("discover-suggest");var a=document.getElementById("discover-suggest-text"),o=document.getElementById("discover-apply-suggest");if(t&&a&&o){var e=computeSegmentStatsFromFeedback();if(!e||e.length<2)t.style.display="none";else{var r=e[0],e=e[1];if(r.ci.lo>e.ci.hi&&r.n>=(segmentMinN||5)&&e.n>=(segmentMinN||5)){let e=lensFromSegment(r.name);e?(a.textContent=r.name+" is outperforming (99% CI). Apply a focused lens?",o.onclick=()=>{applySuggestedLens(e),t.style.display="none"},t.style.display="block"):t.style.display="none"}else t.style.display="none"}}}function lensFromSegment(e){var t;return e&&"string"==typeof e?e.startsWith("Tag:")?{name:"Pattern: "+(t=e.slice(4)),mode:"filter",include:[{all:[{field:"tags",includesAny:[t]},{field:"fitScore",gte:discoverFitMin}]}],exclude:[{field:"status",equals:"rejected"}]}:e.startsWith("Domain:")?{name:"Platform: "+(t=e.slice(7)),mode:"filter",include:[{any:[{field:"jobDomain",includes:t}]}],exclude:[]}:e.startsWith("Level:")?{name:"Level: "+(t=e.slice(6)),mode:"filter",include:[{all:[{field:"roleTitle",matches:"^"+t},{field:"fitScore",gte:discoverFitMin}]}],exclude:[]}:e.startsWith("Policy:Remote")?{name:"Policy: Remote",mode:"filter",include:[{any:[{field:"location",matches:"Remote"}]}],exclude:[]}:null:null}function applySuggestedLens(e){customLens={id:"custom",...e},activeLensId="custom",localStorage.setItem("lensActive",activeLensId),localStorage.setItem("lensCustom",JSON.stringify(customLens)),updateLensIndicator(),applyAllFilters(),showToast("Applied suggested lens","success")}function undoDiscover(){let t=discoveryHistory.pop();var e,a;t?(t.prevModel&&saveModelState(t.prevModel),(e=jobsData.find(e=>e.id===t.jobId))&&"number"==typeof t.prevFit&&(e.fitScore=t.prevFit),e&&!discoveryQueue.find(e=>e.id===t.jobId)&&discoveryQueue.splice(Math.min(t.index||0,discoveryQueue.length),0,e),t.evtId&&0<=(a=(e=JSON.parse(localStorage.getItem("discoveryFeedback")||"[]")).findIndex(e=>e&&e.id===t.evtId))&&(e.splice(a,1),localStorage.setItem("discoveryFeedback",JSON.stringify(e))),saveDataToStorage(),renderDashboard(),applyAllFilters(),renderDiscoverView(),showToast("Undone","success")):showToast("Nothing to undo","error")}function logDiscoveryFeedback(e,t,a){var o=JSON.parse(localStorage.getItem("discoveryFeedback")||"[]"),t={specversion:"1.0",id:`evt_${Date.now()}_`+Math.random().toString(36).slice(2,8),type:"com.jso.discovery.feedback",source:"/discover/ui",time:(new Date).toISOString(),data:{job_id:e.id,label:t,reasons:a,lens_active:activeLensId,feature_snapshot:extractFeatures(e),model_version:JSON.parse(localStorage.getItem("modelState")||"{}").model_version||"v0.2.1",session_id:localStorage.getItem("session_id")||null}};return o.push(t),localStorage.setItem("discoveryFeedback",JSON.stringify(o)),t}function getModelState(){var e={schema_version:"model.v1",weights:{},reason_weights:{},training_count:0,model_version:"v0.2.1",created_at:(new Date).toISOString()};try{return{...e,...JSON.parse(localStorage.getItem("modelState")||"{}")}}catch{return e}}function saveModelState(e){localStorage.setItem("modelState",JSON.stringify(e))}function extractFeatures(e){var t={},a=(e.tags||[]).map(e=>(e||"").toLowerCase()),o=(e.roleTitle||"").toLowerCase().split(" ")[0],r=getJobDomain(e.jobUrl),e=(e.location||"").toLowerCase().includes("remote")||"remote"===e.remote_policy;return a.includes("crypto")&&(t.tag_crypto=1),a.includes("ai")&&(t.tag_ai=1),a.includes("fintech")&&(t.tag_fintech=1),t["level_"+o]=1,e&&(t.remote=1),r.includes("greenhouse.io")&&(t.platform_greenhouse=1),r.includes("lever.co")&&(t.platform_lever=1),r.includes("workday")&&(t.platform_workday=1),t}function dot(e,t){let a=0;for(var o in t)a+=(e[o]||0)*t[o];return a}function sigmoid(e){return 1/(1+Math.exp(-e))}function computeFit(e){return 10*sigmoid(dot(getModelState().weights,e))}function updateModelWithFeedback(o,e,t){if(null!==o){let a=getModelState();var r,n=sigmoid(dot(a.weights,e)),i=(1===o?1:0)-n;for(r in e){var s=e[r];a.weights[r]=(a.weights[r]||0)+.2*i*s}(t||[]).forEach(e=>{let t=.05*(1===o?1:-1);e.includes("domain")&&["platform_greenhouse","platform_lever","platform_workday"].forEach(e=>{void 0!==a.weights[e]&&(a.weights[e]+=t)}),"remote_ok"!==e&&"onsite_only"!==e||(a.weights.remote=(a.weights.remote||0)+t)}),a.training_count=(a.training_count||0)+1,saveModelState(a)}}function renderTableView(){let t=document.getElementById("jobs-table-body");t&&(t.innerHTML="",filteredJobs.forEach(e=>{e=createTableRow(e);t.appendChild(e)}),updateSelectAllState(),updateReviewPanel())}function createTableRow(e){var t=document.createElement("tr"),a=(t.dataset.jobId=e.id,selectedJobs.has(e.id)),o=getActiveLens();return o&&"highlight"===o.mode&&matchesLens(e,o)&&t.classList.add("lens-hit"),t.innerHTML=`
    <td class="select-col">
      <input type="checkbox" ${a?"checked":""}>
    </td>
    <td class="company-cell">
      ${shouldShowLensDot(e)?`<span class="lens-dot" style="background-color:${getActiveLensColor()}"></span>`:""}
      <a href="${e.jobUrl}" target="_blank">${e.company}</a>
    </td>
    <td class="role-cell">
      <div class="role-title">${e.roleTitle}</div>
    </td>
    <td class="link-cell">
      ${renderJobLink(e.jobUrl)}
    </td>
    <td>
      <span class="status-badge ${e.status}">${formatStatus(e.status)}</span>
    </td>
    <td class="fit-score">
      <span class="fit-score-value ${getFitScoreClass(e.fitScore)}">${e.fitScore}</span>
    </td>
    <td>
      <span class="vibe-indicator">${e.vibe}</span>
    </td>
    <td class="salary-cell">${e.salary}</td>
    <td class="date-cell">${e.appliedDate?formatDate(e.appliedDate):"-"}</td>
    <td class="actions-cell">
      <button class="action-btn" onclick="viewJobDetails('${e.id}')" title="View/Edit">
        <i class="fas fa-eye"></i>
      </button>
      <button class="action-btn" onclick="archiveJob('${e.id}')" title="Archive">
        <i class="fas fa-archive"></i>
      </button>
    </td>
  `,t.querySelector('input[type="checkbox"]').addEventListener("change",()=>toggleJobSelection(e.id)),t}function renderJobLink(t){if(!t)return"-";try{var e=new URL(normalizeUrl(t)),a=e.hostname.replace(/^www\./,"");return`<a href="${e.href}" target="_blank" rel="noopener" title="Open job posting">${a} <i class="fas fa-external-link-alt" aria-hidden="true"></i></a>`}catch(e){return`<a href="${(t||"").toString().replace(/"/g,"&quot;")}" target="_blank" rel="noopener"><i class="fas fa-external-link-alt" aria-hidden="true"></i></a>`}}function normalizeUrl(e){return e?(e=e.trim(),/^https?:\/\//i.test(e)?e:"https://"+e):""}function handleSort(r){sortConfig.key===r?sortConfig.direction="asc"===sortConfig.direction?"desc":"asc":(sortConfig.key=r,sortConfig.direction="asc"),filteredJobs.sort((e,t)=>{let a=e[r],o=t[r];return o="fitScore"===r?(a=parseFloat(a)||0,parseFloat(o)||0):"appliedDate"===r?(a=a?new Date(a):new Date(0),o?new Date(o):new Date(0)):(a=(a||"").toString().toLowerCase(),(o||"").toString().toLowerCase()),a<o?"asc"===sortConfig.direction?-1:1:a>o?"asc"===sortConfig.direction?1:-1:0}),renderTableView()}function renderKanbanView(){["not-started","research","applied","interviewing","offer","rejected"].forEach(t=>{let a=document.getElementById(t+"-column");var e,o=document.getElementById(t+"-kanban-count");a&&o&&(e=filteredJobs.filter(e=>e.status===t).sort(compareKanban),o.textContent=e.length,a.innerHTML="",e.forEach(e=>{e=createKanbanCard(e);a.appendChild(e)}),setupColumnDropZone(a,t))})}function compareKanban(e,t){var{key:a,dir:o}=kanbanSort;let r,n;n="fit"===a?(r=parseFloat(e.fitScore)||0,parseFloat(t.fitScore)||0):"company"===a?(r=(e.company||"").toLowerCase(),(t.company||"").toLowerCase()):"applied"===a?(r=e.appliedDate?new Date(e.appliedDate).getTime():0,t.appliedDate?new Date(t.appliedDate).getTime():0):r=0;a=r<n?-1:r>n?1:0;return"asc"===o?a:-a}function createKanbanCard(t){var e=document.createElement("div"),a=(e.className="kanban-card",e.dataset.jobId=t.id,e.draggable=!0,getActiveLens()),a=(a&&"highlight"===a.mode&&matchesLens(t,a)&&e.classList.add("lens-hit"),getFitScoreClass(t.fitScore)),a=(e.innerHTML=`
    <div class="fit-band ${a}"></div>
    <div class="kanban-card-header">
      <span class="kanban-card-company">${shouldShowLensDot(t)?`<span class="lens-dot" style="background-color:${getActiveLensColor()}"></span>`:""}${t.company}</span>
      <div class="kanban-card-fit">
        <span class="fit-score-value ${getFitScoreClass(t.fitScore)}">${t.fitScore}</span>
        <span class="vibe-indicator">${t.vibe}</span>
      </div>
    </div>
    <div class="kanban-card-title">${t.roleTitle}</div>
    <div class="kanban-card-meta">
      <span class="kanban-card-location">${t.location}</span>
      <span class="kanban-card-salary">${t.salary.split(" ")[0]}</span>
    </div>
    <div class="kanban-card-actions">
      <a href="${normalizeUrl(t.jobUrl)}" class="kanban-link" target="_blank" title="Open job posting" aria-label="Open job posting">
        <i class="fas fa-external-link-alt"></i>
      </a>
    </div>
  `,e.addEventListener("dragstart",handleDragStart),e.addEventListener("dragend",handleDragEnd),e.addEventListener("click",e=>{e.preventDefault(),viewJobDetails(t.id)}),e.querySelector(".kanban-link"));return a&&a.addEventListener("click",e=>{e.stopPropagation()}),e}function setupColumnDropZone(e,t){e.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"}),e.addEventListener("drop",e=>{e.preventDefault(),handleDrop(e,t)}),e.addEventListener("dragenter",e=>{e.preventDefault();e=e.currentTarget.closest(".kanban-column");e&&e.classList.add("drag-over")}),e.addEventListener("dragleave",e=>{var t=e.currentTarget.closest(".kanban-column");t&&!t.contains(e.relatedTarget)&&t.classList.remove("drag-over")})}function handleDragStart(e){draggedElement=e.target,e.target.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",e.target.dataset.jobId)}function handleDragEnd(e){e.target.classList.remove("dragging"),document.querySelectorAll(".kanban-column").forEach(e=>{e.classList.remove("drag-over")}),draggedElement=null}function handleDrop(e,t){e.preventDefault();var a=e.target.closest(".kanban-column");a&&a.classList.remove("drag-over");let o=e.dataTransfer.getData("text/plain");o&&(a=jobsData.find(e=>e.id===o))&&a.status!==t&&(e=a.status,a.status=t,a.activityLog.push({date:(new Date).toISOString().split("T")[0],type:"Status Change",note:`Moved from ${formatStatus(e)} to `+formatStatus(t)}),"applied"!==t||a.appliedDate||(a.appliedDate=(new Date).toISOString().split("T")[0]),addToMasterActivityLog("Status Change",a.company+" moved to "+formatStatus(t),a.id),saveDataToStorage(),renderKanbanView(),renderDashboard(),renderGoalsSection(),showToast(a.company+" moved to "+formatStatus(t),"success"))}function viewJobDetails(t){var e,a,o,r=jobsData.find(e=>e.id===t);r&&(currentEditingJob={...r},e=document.getElementById("job-modal"),a=document.getElementById("modal-job-title"),o=document.getElementById("modal-body"),e)&&a&&o&&(a.textContent=r.company+" - "+r.roleTitle,o.innerHTML=createJobEditForm(r),e.classList.remove("hidden"))}function createJobEditForm(e){return`
    <div class="job-edit-form">
      <!-- Basic Information -->
      <div class="form-section">
        <h4>Job Information</h4>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Company</label>
            <input type="text" class="form-control" id="edit-company" value="${e.company}">
          </div>
          <div class="form-group">
            <label class="form-label">Role Title</label>
            <input type="text" class="form-control" id="edit-role" value="${e.roleTitle}">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Job URL (editable for UTM tracking/referral links)</label>
          <input type="url" class="form-control" id="edit-job-url" value="${e.jobUrl}" placeholder="https://...">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Location</label>
            <input type="text" class="form-control" id="edit-location" value="${e.location}">
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-control" id="edit-status">
              <option value="not-started" ${"not-started"===e.status?"selected":""}>Not Started</option>
              <option value="research" ${"research"===e.status?"selected":""}>Research</option>
              <option value="applied" ${"applied"===e.status?"selected":""}>Applied</option>
              <option value="interviewing" ${"interviewing"===e.status?"selected":""}>Interviewing</option>
              <option value="offer" ${"offer"===e.status?"selected":""}>Offer</option>
              <option value="rejected" ${"rejected"===e.status?"selected":""}>Rejected</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Salary</label>
            <input type="text" class="form-control" id="edit-salary" value="${e.salary}">
          </div>
          <div class="form-group">
            <label class="form-label">Fit Score (separate from vibe)</label>
            <input type="number" class="form-control" id="edit-fit-score" min="0" max="10" step="0.1" value="${e.fitScore}">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Vibe (separate from fit score)</label>
            <select class="form-control" id="edit-vibe">
              <option value="üòä" ${"üòä"===e.vibe?"selected":""}>üòä Positive</option>
              <option value="üòê" ${"üòê"===e.vibe?"selected":""}>üòê Neutral</option>
              <option value="üòü" ${"üòü"===e.vibe?"selected":""}>üòü Concerned</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Applied Date</label>
            <input type="date" class="form-control" id="edit-applied-date" value="${e.appliedDate||""}">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Tags (comma-separated)</label>
          <input type="text" class="form-control" id="edit-tags" value="${e.tags.join(", ")}">
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea class="form-control" id="edit-notes" rows="3">${e.notes}</textarea>
        </div>
      </div>

      <!-- Research Section -->
      <div class="form-section">
        <h4>Company Research</h4>
        <div class="form-group">
          <label class="form-label">Company Intel</label>
          <textarea class="form-control" id="edit-company-intel" rows="2">${e.research.companyIntel}</textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Recent News</label>
          <textarea class="form-control" id="edit-recent-news" rows="2">${e.research.recentNews}</textarea>
        </div>
      </div>

      <!-- Activity Timeline -->
      <div class="form-section">
        <h4>Activity Timeline</h4>
        <div class="activity-timeline" id="activity-timeline">
          ${e.activityLog.map((e,t)=>`
            <div class="activity-item">
              <div class="activity-date">${formatDate(e.date)}</div>
              <div class="activity-content">
                <div class="activity-type">${e.type}</div>
                <div class="activity-note">${e.note}</div>
              </div>
            </div>
          `).join("")}
        </div>
      </div>

      <!-- Fit Score History -->
      <div class="form-section">
        <h4>Fit Score History</h4>
        <div class="activity-timeline">
          ${e.fitScoreHistory.map(e=>`
            <div class="activity-item">
              <div class="activity-date">${formatDate(e.date)}</div>
              <div class="activity-content">
                <div class="activity-type">Score: ${e.score}</div>
                <div class="activity-note">${e.reason}</div>
              </div>
            </div>
          `).join("")}
        </div>
      </div>

      <!-- Vibe History -->
      <div class="form-section">
        <h4>Vibe History</h4>
        <div class="activity-timeline">
          ${e.vibeHistory.map(e=>`
            <div class="activity-item">
              <div class="activity-date">${formatDate(e.date)}</div>
              <div class="activity-content">
                <div class="activity-type">Vibe: ${e.vibe}</div>
                <div class="activity-note">${e.reason}</div>
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    </div>
  `}function saveJobChanges(){var e,t,a,o;currentEditingJob&&-1!==(e=jobsData.findIndex(e=>e.id===currentEditingJob.id))&&(a={...t=jobsData[e],company:document.getElementById("edit-company")?.value||t.company,roleTitle:document.getElementById("edit-role")?.value||t.roleTitle,jobUrl:normalizeUrl(document.getElementById("edit-job-url")?.value||t.jobUrl),location:document.getElementById("edit-location")?.value||t.location,status:document.getElementById("edit-status")?.value||t.status,salary:document.getElementById("edit-salary")?.value||t.salary,appliedDate:document.getElementById("edit-applied-date")?.value||t.appliedDate,notes:document.getElementById("edit-notes")?.value||t.notes},(o=parseFloat(document.getElementById("edit-fit-score")?.value)||t.fitScore)!==t.fitScore&&(a.fitScore=o,a.fitScoreHistory=[...t.fitScoreHistory,{date:(new Date).toISOString().split("T")[0],score:o,reason:"Manual update"}]),(o=document.getElementById("edit-vibe")?.value||t.vibe)!==t.vibe&&(a.vibe=o,a.vibeHistory=[...t.vibeHistory,{date:(new Date).toISOString().split("T")[0],vibe:o,reason:"Manual update"}]),o=document.getElementById("edit-tags")?.value||"",a.tags=o.split(",").map(e=>e.trim()).filter(e=>e),a.research={...t.research,companyIntel:document.getElementById("edit-company-intel")?.value||t.research.companyIntel,recentNews:document.getElementById("edit-recent-news")?.value||t.research.recentNews},addToMasterActivityLog("Update",`Updated ${(jobsData[e]=a).company} - `+a.roleTitle,a.id),saveDataToStorage(),closeModals(),applyAllFilters(),renderCurrentView(),renderDashboard(),showToast("Job updated successfully","success"))}function renderAnalyticsView(){setTimeout(()=>{initializeFunnelChart(),initializeFitSuccessChart(),initializeActivityTrendChart(),renderSegmentStats(),renderInsightsSuggestion()},100)}function initializeFunnelChart(){var e,t=document.getElementById("funnel-chart");t&&(charts.funnel&&charts.funnel.destroy(),e=[(e=calculateDashboardStats()).notStarted+e.research+e.applied+e.interviewing+e.offers,e.research+e.applied+e.interviewing+e.offers,e.applied+e.interviewing+e.offers,e.interviewing+e.offers,e.offers],charts.funnel=new Chart(t,{type:"bar",data:{labels:["Total Roles","Research+","Applied+","Interviewing+","Offers"],datasets:[{label:"Pipeline Funnel",data:e,backgroundColor:["#1FB8CD","#FFC185","#B4413C","#ECEBD5","#5D878F"]}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!0}}}}))}function initializeFitSuccessChart(){var e=document.getElementById("fit-success-chart");if(e){charts.fitSuccess&&charts.fitSuccess.destroy();let o={"6-7":{total:0,success:0},"7-8":{total:0,success:0},"8-9":{total:0,success:0},"9-10":{total:0,success:0}};jobsData.forEach(e=>{var t=e.fitScore;let a;a=9<=t?"9-10":8<=t?"8-9":7<=t?"7-8":"6-7",o[a].total++,["interviewing","offer"].includes(e.status)&&o[a].success++});var t=Object.values(o).map(e=>0<e.total?e.success/e.total*100:0);charts.fitSuccess=new Chart(e,{type:"bar",data:{labels:Object.keys(o),datasets:[{label:"Success Rate %",data:t,backgroundColor:"#1FB8CD"}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,max:100}}}})}}function initializeActivityTrendChart(){var e=document.getElementById("activity-trend-chart");e&&(charts.activityTrend&&charts.activityTrend.destroy(),charts.activityTrend=new Chart(e,{type:"line",data:{labels:["Week 1","Week 2","Week 3","Week 4"],datasets:[{label:"Applications",data:[0,2,5,8],borderColor:"#1FB8CD",backgroundColor:"rgba(31, 184, 205, 0.1)",tension:.4},{label:"Interviews",data:[0,0,1,3],borderColor:"#FFC185",backgroundColor:"rgba(255, 193, 133, 0.1)",tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}}))}function renderSegmentStats(){var e,t,a,o=document.getElementById("segment-stats");o&&(e=computeSegmentStatsFromFeedback(),t=document.getElementById("segment-summary"),0===e.length?(o.innerHTML='<div class="segment-stat">No discovery feedback yet. Use Discover to start training.</div>',t&&(t.textContent="")):(a=e[0],t&&(t.textContent=`${a.name}: ${(100*a.rate).toFixed(0)}% (n=${a.n}, 99% CI ${(100*a.ci.lo).toFixed(0)}‚Äì${(100*a.ci.hi).toFixed(0)}%, Œî WoW ${(100*a.deltaWoW).toFixed(0)}%)`),o.innerHTML=e.map(e=>`
    <div class="segment-stat" title="n=${e.n}
yes=${e.yes} no=${e.no}
rate=${(100*e.rate).toFixed(0)}%
99% CI ${(100*e.ci.lo).toFixed(0)}‚Äì${(100*e.ci.hi).toFixed(0)}%
WoW: ${(100*e.currRate).toFixed(0)}% (n=${e.currN}) vs ${(100*e.prevRate).toFixed(0)}% (n=${e.prevN})
Œî ${(100*e.deltaWoW).toFixed(0)}%">
      <span class="segment-name">${e.name} (n=${e.n})</span>
      <span class="segment-score">${(100*e.rate).toFixed(0)}% <small style="color: var(--color-text-secondary);">(Œî ${(100*e.deltaWoW).toFixed(0)}%)</small></span>
    </div>
  `).join("")))}function renderInsightsSuggestion(){var t=document.getElementById("insights-suggest");if(t){var a=computeSegmentStatsFromFeedback();if(!a||a.length<2)t.innerHTML="<em>Gather a few labels in Triage to see suggestions.</em>";else{var o=a[0],a=a[1];if(o.ci.lo>a.ci.hi&&o.n>=(segmentMinN||5)&&a.n>=(segmentMinN||5)){let e=lensFromSegment(o.name);e?(a=lensToSummary(e),t.innerHTML=`Winner: <strong>${o.name}</strong> ‚Äî ${(100*o.rate).toFixed(0)}% (n=${o.n}, 99% CI ${(100*o.ci.lo).toFixed(0)}‚Äì${(100*o.ci.hi).toFixed(0)}%)<br>
  <small>${a}</small><br>
  <button class="btn btn--sm btn--primary" id="insights-apply-suggest">Apply Suggested Lens</button>`,(o=document.getElementById("insights-apply-suggest"))&&(o.onclick=()=>{applySuggestedLens(e),showToast("Lens applied","success")})):t.innerHTML="<em>No suggestion</em>"}else t.innerHTML="<em>No strong recommendation yet. Keep labeling.</em>"}}}function computeSegmentStatsFromFeedback(){var e=JSON.parse(localStorage.getItem("discoveryFeedback")||"[]");if(!Array.isArray(e)||0===e.length)return[];let n={};var t=Date.now();let i=t-6048e5,s=t-12096e5,l=new Map(jobsData.map(e=>[e.id,e]));e.forEach(o=>{if(o&&o.data){let{job_id:e,label:a}=o.data;if(null!=a){var r=l.get(e);if(r){let t=Date.parse(o.time||"")||0;deriveSegments(r).forEach(e=>{n[e]||(n[e]={yes:0,no:0,cYes:0,cNo:0,pYes:0,pNo:0}),1===a?n[e].yes++:n[e].no++,t>=i?1===a?n[e].cYes++:n[e].cNo++:t>=s&&t<i&&(1===a?n[e].pYes++:n[e].pNo++)})}}}});return Object.entries(n).map(([e,t])=>{var a=t.yes+t.no,o=0<a?t.yes/a:0,r=wilson(o,a,2.575829),n=t.cYes+t.cNo,i=t.pYes+t.pNo,s=0<n?t.cYes/n:0,l=0<i?t.pYes/i:0;return{name:e,yes:t.yes,no:t.no,n:a,rate:o,ci:r,currRate:s,prevRate:l,currN:n,prevN:i,deltaWoW:s-l}}).filter(e=>e.n>=(segmentMinN||5)).sort((e,t)=>t.rate-e.rate).slice(0,8)}function wilson(e,t,a){var o,r,n;return 0===t?{lo:0,hi:0}:(o=1+(n=a*a)/t,e=((r=e+n/(2*t))-(a=a*Math.sqrt(e*(1-e)/t+n/(4*t*t))))/o,n=(r+a)/o,{lo:e=Math.max(0,Math.min(1,e)),hi:n=Math.max(0,Math.min(1,n))})}function deriveSegments(e){let t=[],a=(e.tags||[]).map(e=>e.toString());["Crypto","AI","FinTech","DeFi"].forEach(e=>{a.includes(e)&&t.push("Tag:"+e)});var o=getJobDomain(e.jobUrl),o=(o&&t.push("Domain:"+o),(e.roleTitle||"").split(" ")[0]),o=(o&&t.push("Level:"+o),(e.location||"").toLowerCase().includes("remote")||"remote"===e.remote_policy);return t.push(o?"Policy:Remote":"Policy:Non-Remote"),t}function handleSearch(e){currentFilters.search=e.target.value.toLowerCase(),applyAllFilters()}function toggleFilters(){var e=document.getElementById("filters-panel"),t=document.getElementById("filter-btn");e&&t&&(e.classList.toggle("hidden"),t.classList.toggle("active"))}function applyFilters(){currentFilters.status=Array.from(document.querySelectorAll(".status-filter:checked")).map(e=>e.value),currentFilters.vibe=Array.from(document.querySelectorAll(".vibe-filter:checked")).map(e=>e.value);var e=document.getElementById("fit-score-range");e&&(currentFilters.fitScore=parseFloat(e.value)),applyAllFilters(),updateFilterIndicator(),saveDataToStorage()}function applyAllFilters(){var e="archive"===currentView?jobsData.filter(e=>e.isArchived):jobsData.filter(e=>!e.isArchived);filteredJobs=e.filter(e=>{if(currentFilters.search&&!(e.company+` ${e.roleTitle} `+e.tags.join(" ")).toLowerCase().includes(currentFilters.search))return!1;return!(0<currentFilters.status.length&&!currentFilters.status.includes(e.status)||0<currentFilters.vibe.length&&!currentFilters.vibe.includes(e.vibe)||e.fitScore<currentFilters.fitScore||currentFilters.needsReview&&!e.needsReview)});let t=getActiveLens();t&&"filter"===t.mode&&(filteredJobs=filteredJobs.filter(e=>matchesLens(e,t))),renderCurrentView()}function getActiveLens(){return"custom"===activeLensId?customLens:"pacing"===activeLensId?buildPacingLens():"prompt"===activeLensId?promptLens:"none"!==activeLensId&&lensPresets.find(e=>e.id===activeLensId)||null}function buildPacingLens(){return{id:"pacing",name:"Pacing: This Week",mode:"filter",color:"#6366F1",include:[{all:[{field:"status",in:["not-started","research","applied"]},{field:"fitScore",gte:Math.max(0,Math.min(10,25<=goals?.offerRate?8:7.5))}]}],exclude:[{field:"status",equals:"rejected"}]}}function getActiveLensColor(){return getActiveLens()?.color||getComputedStyle(document.documentElement).getPropertyValue("--color-primary")||"#2b6cb0"}function matchesLens(t,e){if(e?.include&&0<e.include.length&&!e.include.some(e=>evalRule(t,e)))return!1;if(e?.exclude&&0<e.exclude.length&&e.exclude.some(e=>evalRule(t,e)))return!1;return!0}function evalRule(t,e){if(!e)return!0;if(Array.isArray(e.all))return e.all.every(e=>evalRule(t,e));if(Array.isArray(e.any))return e.any.some(e=>evalRule(t,e));if(e.not)return!evalRule(t,e.not);var a=e.field;let o=getFieldValue(t,a);return"jobUrl"!==a&&"jobDomain"!==a||"jobDomain"===a&&(o=getJobDomain(t.jobUrl)),compareValue(o,e)}function getFieldValue(e,t){if(t)return"jobDomain"===t?getJobDomain(e.jobUrl):e[t]}function getJobDomain(e){try{return new URL(normalizeUrl(e||"")).hostname.replace(/^www\./,"")}catch(e){return""}}function compareValue(e,a){if(void 0!==a.equals)return toStr(e)===toStr(a.equals);if(Array.isArray(a.in))return a.in.map(toStr).includes(toStr(e));if(void 0!==a.includes)return toStr(e).includes(toStr(a.includes));if(Array.isArray(a.includesAny)){let t=Array.isArray(e)?e.map(toStr):toStr(e).split(/\s*[;,]\s*|\s+/).filter(Boolean);return a.includesAny.map(toStr).some(e=>t.includes(e))}if(void 0!==a.gte)return toNum(e)>=Number(a.gte);if(void 0!==a.lte)return toNum(e)<=Number(a.lte);if(a.matches)try{return new RegExp(a.matches,"i").test(toStr(e))}catch(e){return!1}return!0}function toStr(e){return(e??"").toString().toLowerCase()}function toNum(e){e=parseFloat(e);return isNaN(e)?0:e}function openLensesModal(){var e=document.getElementById("lenses-modal");if(e){var a=e.querySelectorAll('input[name="lens"]');a.forEach(e=>{e.checked=e.value===activeLensId});let t=document.getElementById("lens-custom-wrap");var o=document.getElementById("lens-custom-json"),o=(o&&(o.value=JSON.stringify(customLens,null,2)),t&&(t.style.display="custom"===activeLensId?"block":"none"),a.forEach(e=>e.addEventListener("change",()=>{t&&(t.style.display="custom"===e.value?"block":"none")})),document.getElementById("lens-prompt-card"));o&&(o.style.display=promptLens?"block":"none"),e.classList.remove("hidden")}}function applyLensSelection(){var e=document.getElementById("lenses-modal");if(e){e=e.querySelector('input[name="lens"]:checked'),e=e?e.value:"none";if("custom"===(activeLensId=e))try{var t=JSON.parse(document.getElementById("lens-custom-json").value||"{}");customLens={...customLens,...t}}catch(e){return void showToast("Invalid custom lens JSON","error")}localStorage.setItem("lensActive",activeLensId),localStorage.setItem("lensCustom",JSON.stringify(customLens)),updateLensIndicator(),applyAllFilters(),closeModals()}}function updateLensIndicator(){var e=document.getElementById("lens-indicator");if(e){var t=getActiveLens();if(t){var a=(t.include?.length||0)+(t.exclude?.length||0);if(0<a)return e.textContent=t.name?t.name.split(":")[0]:String(a),e.classList.remove("hidden"),void updateLensSummaryChip()}e.classList.add("hidden"),updateLensSummaryChip()}}function updateLensSummaryChip(){var e,t,a=document.getElementById("lens-summary-chip");a&&((e=getActiveLens())?(t=lensToSummary(e),a.textContent=t,a.title=lensToTooltip(e)):(a.textContent="Lens: None",a.title="No active lens"))}function lensToSummary(e){var t=[],a=(e.name&&t.push(e.name),collectRuleValues(e.include,"tags","includesAny")),a=(a.length&&t.push("Tags: "+a.join(",")),collectRuleValues(e.include,"jobDomain","includes")),a=(a.length&&t.push("Domain: "+a.join("/")),collectGte(e.include,"fitScore")),a=(null!==a&&t.push("Fit ‚â• "+a),collectIn(e.include,"status")),a=(a.length&&t.push("Status: "+a.join(",")),collectIn(e.exclude,"status"));return a.length&&t.push("Excluding: "+a.join(",")),t.join(" ‚Ä¢ ")}function lensToTooltip(e){var t=[];t.push(e.name||"Lens"),t.push("highlight"===e.mode?"Mode: highlight (visual only)":"Mode: filter"),t.push("");let a=[],o=((e.include||[]).forEach(e=>walkRule(e,e=>{var t;e.field&&(t=[],void 0!==e.equals&&t.push("= "+e.equals),e.in&&t.push(`in [${e.in.join(", ")}]`),void 0!==e.includes&&t.push("includes "+e.includes),e.includesAny&&t.push(`includesAny [${e.includesAny.join(", ")}]`),void 0!==e.gte&&t.push(">= "+e.gte),void 0!==e.lte&&t.push("<= "+e.lte),e.matches&&t.push(`~ /${e.matches}/i`),a.push(`‚Ä¢ ${e.field} `+t.join(" ")))})),a.length&&(t.push("Include:"),t.push(...a),t.push("")),[]);return(e.exclude||[]).forEach(e=>walkRule(e,e=>{var t;e.field&&(t=[],void 0!==e.equals&&t.push("= "+e.equals),e.in&&t.push(`in [${e.in.join(", ")}]`),void 0!==e.includes&&t.push("includes "+e.includes),e.includesAny&&t.push(`includesAny [${e.includesAny.join(", ")}]`),void 0!==e.gte&&t.push(">= "+e.gte),void 0!==e.lte&&t.push("<= "+e.lte),e.matches&&t.push(`~ /${e.matches}/i`),o.push(`‚Ä¢ ${e.field} `+t.join(" ")))})),o.length&&(t.push("Exclude:"),t.push(...o)),t.join("\n")}function collectRuleValues(e,t,a){let o=new Set;return(e||[]).forEach(e=>walkRule(e,e=>{e.field===t&&void 0!==e[a]&&(Array.isArray(e[a])?e[a]:[e[a]]).forEach(e=>o.add(String(e)))})),Array.from(o)}function collectGte(e,t){let a=null;return(e||[]).forEach(e=>walkRule(e,e=>{e.field===t&&"number"==typeof e.gte&&(a=null===a?e.gte:Math.max(a,e.gte))})),a}function collectIn(e,t){let a=new Set;return(e||[]).forEach(e=>walkRule(e,e=>{e.field===t&&Array.isArray(e.in)&&e.in.forEach(e=>a.add(String(e)))})),Array.from(a)}function walkRule(e,t){if(e)return Array.isArray(e.all)?e.all.forEach(e=>walkRule(e,t)):Array.isArray(e.any)?e.any.forEach(e=>walkRule(e,t)):e.not?walkRule(e.not,t):void t(e)}function shouldShowLensDot(e){var t=getActiveLens();return!!t&&matchesLens(e,t)}function savePromptLens(){try{var e=JSON.parse(document.getElementById("lens-custom-json").value||"{}");if(!e||!e.include&&!e.exclude)throw new Error("Empty lens");promptLens={id:"prompt",name:e.name||"Prompt",mode:e.mode||"filter",include:e.include||[],exclude:e.exclude||[]},localStorage.setItem("lensPrompt",JSON.stringify(promptLens)),activeLensId="prompt",localStorage.setItem("lensActive",activeLensId),updateLensIndicator(),applyAllFilters(),closeModals(),showToast("Saved prompt lens and applied","success")}catch(e){showToast("Invalid custom JSON for prompt lens","error")}}function clearFilters(){currentFilters={status:[],fitScore:0,vibe:[],search:""};var e=document.getElementById("search-input"),e=(e&&(e.value=""),document.querySelectorAll(".status-filter").forEach(e=>e.checked=!1),document.querySelectorAll(".vibe-filter").forEach(e=>e.checked=!1),document.getElementById("fit-score-range"));e&&(e.value=0),updateFitScoreLabel(),applyAllFilters(),updateFilterIndicator(),saveDataToStorage()}function updateFilterIndicator(){var e=[...currentFilters.status,...currentFilters.vibe,0<currentFilters.fitScore?"fit-score":null,currentFilters.search?"search":null,currentFilters.needsReview?"needs-review":null].filter(Boolean),t=document.getElementById("filter-count");t&&(0<e.length?(t.textContent=e.length,t.classList.remove("hidden")):t.classList.add("hidden"))}function updateFitScoreLabel(){var e=document.getElementById("fit-score-range"),t=document.getElementById("fit-score-value");e&&t&&(t.textContent=e.value+"+")}function toggleJobSelection(e){selectedJobs.has(e)?selectedJobs.delete(e):selectedJobs.add(e),updateBulkActions(),renderCurrentView()}function handleSelectAll(e){e.target.checked?filteredJobs.forEach(e=>selectedJobs.add(e.id)):selectedJobs.clear(),updateBulkActions(),renderCurrentView()}function updateSelectAllState(){var e=document.getElementById("select-all");if(e){let t=new Set(filteredJobs.map(e=>e.id));var a=Array.from(selectedJobs).filter(e=>t.has(e));0===a.length?(e.checked=!1,e.indeterminate=!1):a.length===filteredJobs.length?(e.checked=!0,e.indeterminate=!1):(e.checked=!1,e.indeterminate=!0)}}function updateBulkActions(){var e=document.getElementById("bulk-actions"),t=document.getElementById("bulk-counter");e&&t&&(0<selectedJobs.size?(e.classList.remove("hidden"),t.textContent=selectedJobs.size+" selected"):e.classList.add("hidden"),updateSelectAllState())}function handleExport(){var e=validateJobsForExport(filteredJobs);downloadCSV(exportToCSV(e.jobs),"job-search-data.csv"),0<e.invalidCount?showToast(`Exported with ${e.invalidCount} invalid records skipped`,"error"):showToast("Data exported successfully","success")}function exportToCSV(e){return[["Schema Version","ID","Company","Role","Job URL","Job Domain","Status","Fit Score","Fit Conf","Fit Model","Vibe","Salary","Salary Min","Salary Max","Currency","Period","Applied Date","Location","Country Code","Timezone","Remote Policy","Employment Type","Level","Notes","Tags","Skills","Source Type","Platform","Experiment ID"],...e.map(e=>["jobs.v1",e.id,e.company,e.roleTitle,e.jobUrl,getJobDomain(e.jobUrl),e.status,e.fitScore,e.fit&&e.fit.conf||"",e.fit&&e.fit.model_version||"",e.vibe,e.salary,"","","","",e.appliedDate||"",e.location,e.country_code||"",e.timezone||"",e.remote_policy||"",e.employment_type||"",e.level||"",e.notes||"",(e.tags||[]).join("; "),(e.skills||[]).join("; "),e.sourceType||"",e.platform||"",e.experimentId||""])].map(e=>e.map(e=>`"${(e||"").toString().replace(/"/g,'""')}"`).join(",")).join("\n")}function downloadCSV(e,t){var e=new Blob([e],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a");a.href=URL.createObjectURL(e),a.download=t,a.click()}function validateJobsForExport(e){var t,a=[];let o=0;for(t of e)if(t){var r=t.id&&t.company&&t.roleTitle&&t.jobUrl&&t.status;let e=!0;try{t.jobUrl&&new URL(normalizeUrl(t.jobUrl))}catch{e=!1}r&&e?a.push(t):o++}else o++;return{jobs:a,invalidCount:o}}function exportJobsJSONL(e){return e.map(e=>JSON.stringify(toJobsV1Record(e))).join("\n")}function toJobsV1Record(e){return{schema_version:"jobs.v1",id:e.id,company:e.company,title:e.roleTitle,jobUrl:e.jobUrl,jobDomain:getJobDomain(e.jobUrl),location:e.location,country_code:e.country_code||null,timezone:e.timezone||null,remote_policy:e.remote_policy||null,employment_type:e.employment_type||null,level:e.level||null,salary:e.salary_struct||null,tags:e.tags||[],skills:e.skills||[],sourceType:e.sourceType||null,platform:e.platform||null,status:e.status,lifecycle_dates:e.lifecycle_dates||{},fit:e.fit||{score:e.fitScore},experimentId:e.experimentId||null,provenance:e.provenance||{data_source:"app",updated_at:(new Date).toISOString()}}}function exportFeedbackJSONL(){var e=JSON.parse(localStorage.getItem("discoveryFeedback")||"[]");let t=[];return e.forEach(e=>{e&&e.data&&"job_id"in e.data&&t.push(JSON.stringify(e))}),t.join("\n")}function exportLensesJSON(){var e={schema_version:"lens.v1",active:activeLensId,presets:lensPresets,custom:customLens,prompt:promptLens};return JSON.stringify(e,null,2)}function exportModelJSON(){var e=JSON.parse(localStorage.getItem("modelState")||"{}"),t={schema_version:"model.v1",weights:{},reason_weights:{},training_count:0,created_at:(new Date).toISOString()};return JSON.stringify({...t,...e},null,2)}async function handleExportBundle(){if("undefined"==typeof JSZip)showToast("JSZip not loaded","error");else{var t,a=new JSZip,o=validateJobsForExport(jobsData),r=o.jobs,n=[];let e=null;try{"undefined"!=typeof Ajv&&(e=await validateWithAjv(r),window.__lastSchemaReport=e)}catch(e){console.warn("Ajv validation failed",e)}try{for(t of[{name:"schemas/jobs.v1.schema.json",path:"schemas/jobs.v1.schema.json"},{name:"schemas/feedback.v1.schema.json",path:"schemas/feedback.v1.schema.json"},{name:"schemas/lens.v1.schema.json",path:"schemas/lens.v1.schema.json"},{name:"schemas/model.v1.schema.json",path:"schemas/model.v1.schema.json"}]){var i,s=await fetch(t.path).catch(()=>null);s&&s.ok&&(i=await s.text(),n.push({name:t.name,data:new Blob([i],{type:"application/json"})}))}}catch(e){console.warn("Including schemas failed",e)}var l,c=exportToCSV(r),c=(n.push({name:"jobs.csv",data:new Blob([c],{type:"text/csv"})}),exportJobsJSONL(r)),c=(n.push({name:"jobs.jsonl",data:new Blob([c],{type:"application/json"})}),exportFeedbackJSONL()),d=(n.push({name:"feedback.jsonl",data:new Blob([c],{type:"application/json"})}),exportLensesJSON()),d=(n.push({name:"lenses.json",data:new Blob([d],{type:"application/json"})}),exportModelJSON()),d=(n.push({name:"model.json",data:new Blob([d],{type:"application/json"})}),`Job Search Optimizer v2 Export
Generated: ${(new Date).toISOString()}
Schemas: jobs.v1, feedback.v1, lens.v1, model.v1
Counts: jobs=${r.length} events=${c&&c.split(/\n/).filter(Boolean).length||0}
`),r=(n.push({name:"README.txt",data:new Blob([d],{type:"text/plain"})}),await buildChecksums(n));n.push({name:"checksums.txt",data:new Blob([r],{type:"text/plain"})});for(l of n){var u=await l.data.arrayBuffer();a.file(l.name,u)}c=await a.generateAsync({type:"blob"}),d=URL.createObjectURL(c),r=document.createElement("a");r.href=d,r.download=`jso_export_${Date.now()}.zip`,r.click(),e?({jobsErrors:c,feedbackErrors:d}=e,c||d?(showToast(`Bundle exported with schema issues (jobs:${c||0}, feedback:${d||0})`,"error"),showSchemaReport(e)):showToast("Bundle exported (schemas valid)","success")):0<o.invalidCount?showToast(`Bundle exported with ${o.invalidCount} invalid records skipped`,"error"):showToast("Bundle exported","success")}}async function buildChecksums(e){var t,a=[];for(t of e){var o=await t.data.arrayBuffer(),o=await crypto.subtle.digest("SHA-256",o),o=[...new Uint8Array(o)].map(e=>e.toString(16).padStart(2,"0")).join("");a.push(`SHA256  ${o}  `+t.name)}return a.join("\n")}async function validateWithAjv(e){var t=new Ajv({allErrors:!0,strict:!1}),a=async e=>{try{var t=await fetch(e);return t.ok?await t.json():null}catch{return null}},o=await a("schemas/jobs.v1.schema.json"),a=await a("schemas/feedback.v1.schema.json"),r=o?t.compile(o):null,n=a?t.compile(a):null;let i=0,s=0;var l,c=[],d=[];if(r)for(var u of e){u=toJobsV1Record(u);r(u)||(i++,c.length<5&&c.push({id:u.id,errors:(r.errors||[]).map(e=>`${e.instancePath||"/"} `+e.message)}))}if(n)for(l of JSON.parse(localStorage.getItem("discoveryFeedback")||"[]")||[])n(l)||(s++,d.length<5&&d.push({id:l&&l.id,errors:(n.errors||[]).map(e=>`${e.instancePath||"/"} `+e.message)}));return{jobsErrors:i,feedbackErrors:s,jobsErrs:c,fbErrs:d}}function showSchemaReport(e){let t=document.getElementById("schema-report-modal");var o=document.getElementById("schema-report-body"),r=document.getElementById("schema-report-ok"),n=document.getElementById("schema-report-close");if(t&&o){let a=[];a.push("Jobs errors: "+(e.jobsErrors||0)),(e.jobsErrs||[]).forEach((e,t)=>{a.push(`  [${t+1}] id=`+e.id),(e.errors||[]).forEach(e=>a.push("    - "+e))}),a.push(""),a.push("Feedback errors: "+(e.feedbackErrors||0)),(e.fbErrs||[]).forEach((e,t)=>{a.push(`  [${t+1}] id=`+e.id),(e.errors||[]).forEach(e=>a.push("    - "+e))}),o.textContent=a.join("\n"),t.classList.remove("hidden");e=()=>t.classList.add("hidden");r&&(r.onclick=e),n&&(n.onclick=e)}}function renderDashboard(){var e=calculateDashboardStats(),e={"total-roles":e.total,"active-roles":e.active,"avg-fit-score":e.avgFitScore,"offers-count":e.offers,"interviewing-count":e.interviewing,"applied-count":e.applied,"not-started-count":e.notStarted};Object.entries(e).forEach(([e,t])=>{e=document.getElementById(e);e&&(e.textContent=t)}),renderMilestonesDashboard(),renderPacePanel(),renderCoachingBanner()}function calculateDashboardStats(){var e=jobsData.filter(e=>!e.isArchived),t=e.length,a=e.filter(e=>!["rejected"].includes(e.status)).length,o=0<t?(e.reduce((e,t)=>e+t.fitScore,0)/t).toFixed(1):"0.0",e=e.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+1,e),{});return{total:t,active:a,avgFitScore:o,offers:e.offer||0,interviewing:e.interviewing||0,applied:e.applied||0,research:e.research||0,notStarted:e["not-started"]||0}}function formatStatus(e){return e.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}function getFitScoreClass(e){return 9<=e?"excellent":8<=e?"good":7<=e?"fair":"poor"}function renderMilestonesDashboard(){var e,t,a,o,r=document.getElementById("milestones");r&&(e=(t=JSON.parse(localStorage.getItem("discoveryFeedback")||"[]")).filter(e=>1===e?.data?.label).length,t=t.filter(e=>0===e?.data?.label).length,a=jobsData.filter(e=>!e.needsReview&&"not-started"===e.status).length,o=discoverStreak||0,r.innerHTML=[badge("Auto-adds",a,"success","Roles accepted directly into backlog"),badge("Yes",e,"success","Yes labels in Discover"),badge("No",t,"info","No labels in Discover"),badge("Streak",o,5<=o?"success":"info","Current Yes streak")].join(""))}function badge(e,t,a,o){return`<span class="badge-pill ${a}" title="${o}"><i class="fas fa-star"></i> ${e}: ${t}</span>`}function renderPacePanel(){var e,t,a,o=document.getElementById("pace-apps-fill"),r=document.getElementById("pace-apps-meta"),n=document.getElementById("pace-discover-fill"),i=document.getElementById("pace-discover-meta");o&&r&&n&&i&&(e=goals.targetOffers,t=goals.timelineWeeks,e=Math.ceil(e/(goals.interviewRate/100*(goals.offerRate/100))),e=Math.ceil(e/t),t=countAppliedThisWeek(),a=Math.min(100,Math.round(t/Math.max(1,e)*100)),o.style.width=a+"%",r.textContent=t+"/"+e,o=countFeedbackThisWeek(),a=2*e,r=Math.min(100,Math.round(o/Math.max(1,a)*100)),n.style.width=r+"%",i.textContent=o+"/"+a)}function countAppliedThisWeek(){let t=Date.now();return jobsData.filter(e=>e.appliedDate&&t-Date.parse(e.appliedDate)<=6048e5).length}function countFeedbackThisWeek(){var e=JSON.parse(localStorage.getItem("discoveryFeedback")||"[]");let t=Date.now();return e.filter(e=>e?.time&&t-Date.parse(e.time)<=6048e5).length}function renderCoachingBanner(){var t=document.getElementById("coaching-banner");if(t){var a=countAppliedThisWeek(),o=countFeedbackThisWeek(),r=goals.targetOffers,n=goals.timelineWeeks,r=Math.ceil(r/(goals.interviewRate/100*(goals.offerRate/100))),r=Math.ceil(r/n);let e="";e=r<=a?`Great pace! You hit ${a}/${r} applications this week. Consider tightening your lens to exploit winning segments.`:o<r?`Quick win: label ${r-o} more roles in Discover to feed your backlog.`:`You're close! ${r-a} more applications will keep you on track.`,t.textContent=e,t.style.display="block"}}function formatDate(e){return e?new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"-"}function closeModals(){document.querySelectorAll(".modal").forEach(e=>{e.classList.add("hidden")}),currentEditingJob=null}function showToast(t,a="info"){var o=document.getElementById("toast-container");if(o){let e=document.createElement("div");e.className="toast "+a;e.innerHTML=`
    <i class="toast-icon ${{success:"fas fa-check-circle",error:"fas fa-exclamation-circle",info:"fas fa-info-circle"}[a]}"></i>
    <span class="toast-message">${t}</span>
    <button class="toast-close" onclick="this.parentElement.remove()">
      <i class="fas fa-times"></i>
    </button>
  `,o.appendChild(e),setTimeout(()=>{e.parentElement&&e.remove()},5e3)}}document.addEventListener("DOMContentLoaded",function(){initializeApp()}),window.toggleJobSelection=toggleJobSelection,window.viewJobDetails=viewJobDetails,window.archiveJob=archiveJob,window.restoreJob=restoreJob;